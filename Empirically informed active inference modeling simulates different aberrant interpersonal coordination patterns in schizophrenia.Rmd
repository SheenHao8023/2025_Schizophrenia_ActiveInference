---
title: "Empirically informed active inference modeling simulates different aberrant interpersonal coordination patterns in schizophrenia"
author: "XinHao"
date: "2025-10-23"
output: html_document
---

## Toolbox import and data preparation
```{r code and data preparation}
packages <- c("ggprism", "actuar", "EnvStats", "statmod", "SuppDists", "ggsci", "ggpubr", "ggplot2", "dplyr", "tidyr", "readr", "readxl", "openxlsx", "stringr", "ggExtra", "bruceR", "emmeans", "corrplot", "patchwork", "tidyverse", "fitdistrplus", "transport", "philentropy", "lm.beta")  
for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)} else {library(pkg, character.only = TRUE)}}

raw_dir <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/empirical_data/behav_rawfiles"
main_file <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/empirical_data/data_behav&sympt.xlsx"
basepath = 'C:/Users/XinHao/Desktop/2025_SCZ_AI/empirical_data/'
file_list <- list.files(raw_dir, pattern = "\\.xlsx$", full.names = TRUE)
mean_values <- data.frame(SubID = character(), IC = numeric(), WS = numeric(), stringsAsFactors = FALSE)
for (file in file_list) {sub_id <- str_extract(basename(file), "\\d{5}")
  dat <- read_excel(file)
  ic_mean <- mean(dat$IC, na.rm = TRUE)
  ws_mean <- mean(dat$WS, na.rm = TRUE)
  wsearlier_mean <- mean(dat$WSearlier, na.rm = TRUE)
  rd_mean <- mean(dat$RDearlier, na.rm = TRUE)
  mean_values <- rbind(mean_values, data.frame(SubID = sub_id, IC = ic_mean, WS = ws_mean, 
                                               WSearlier = wsearlier_mean, RDearlier = rd_mean))}

main_data <- read.xlsx(main_file)
main_data <- main_data %>%
  left_join(mean_values, by = "SubID") %>%
  {df <- .
    if ("IC.y" %in% names(df)) {df <- df %>%
        dplyr::select(-any_of(c("IC.x", "WS.x", "WSearlier.x", "RDearlier.x"))) %>%
        rename(IC = IC.y, WS = WS.y,  WSearlier = WSearlier.y, RDearlier = RDearlier.y)}
    df %>%
      mutate(IC_scaled = 1 / (1 + exp(-scale(IC))),
        WS_scaled = 1 / (1 + exp(-scale(WS))),
        WSearlier_scaled = 1 / (1 + exp(-scale(WSearlier))),
        RDearlier_scaled = 1 / (1 + exp(-scale(RDearlier))))}
write.xlsx(main_data, main_file, overwrite = TRUE)

set.seed(8023) 
```

## statistic function preparation
```{r statistic function}
chi_square_perm_test <- function(data, var, group_var = "Group2", B = 5000) {
  tab <- table(data[[group_var]], data[[var]])
  complete_cases <- complete.cases(data[[group_var]], data[[var]])
  data_complete <- data[complete_cases, ]
  tab <- table(data_complete[[group_var]], data_complete[[var]])
  n <- sum(tab)
  r <- nrow(tab)  
  c <- ncol(tab)  
  cat("crosstab dimension:", r, "×", c, "\n")
  chi_real <- chisq.test(tab, simulate.p.value = n < 50)
  chi_stat_real <- chi_real$statistic
  p_real <- chi_real$p.value
  cramer_v_real <- sqrt(chi_stat_real / (n * (min(r, c) - 1))) 
  perm_stats <- numeric(B)
  for (i in 1:B) {perm_groups <- sample(data_complete[[group_var]])
    tab_perm <- table(perm_groups, data_complete[[var]])
    chi_perm <- suppressWarnings(chisq.test(tab_perm, simulate.p.value = FALSE))
    perm_stats[i] <- chi_perm$statistic}
  p_perm <- mean(perm_stats >= chi_stat_real)
  list(variable = var,chi_square = as.numeric(chi_stat_real),df = chi_real$parameter,
      p_value = p_real,p_permutation = p_perm,cramers_v = cramer_v_real,contingency_table = tab,
      n = n,dimensions = c(r, c), B = B)
}

print_chi_result <- function(res) {
  cat("\n", rep("=", 70), "\n", sep = "")
  cat("Varible:", res$variable, "(", res$dimensions[1], "×", res$dimensions[2], "table)\n")
  cat(rep("-", 70), "\n", sep = "")
  
  cat("Frequency:\n")
  print(res$contingency_table)
  cat("\nrow pencentage(%):\n")
  prop_tab <- prop.table(res$contingency_table, margin = 1) * 100
  print(round(prop_tab, 1))
  
  cat(sprintf("\nstatistics: χ²(%.0f) = %.2f, p = %.4f", res$df, res$chi_square, res$p_value))
  cat(sprintf("\npermutation test: p = %.4f ", res$p_permutation))
  cat(sprintf("\neffect size: Cramér's V = %.3f", res$cramers_v))
  cat("sample size: n =", res$n, "\n")
  cat(rep("=", 70), "\n\n", sep = "")
}

wilcoxon_perm_test <- function(df, var1, var2, B = 5000) {
  test_real <- wilcox.test(df[[var1]], df[[var2]], paired = TRUE, exact = FALSE, correct = FALSE)
  W_real <- test_real$statistic
  diffs <- df[[var1]] - df[[var2]]
  n <- sum(!is.na(diffs))
  mu_w <- n*(n+1)/4
  W_perm <- replicate(B, {s <- sample(c(1,-1), n, replace = TRUE)
    d <- s * abs(diffs)    
    as.numeric(wilcox.test(d, mu = 0, exact = FALSE, correct = FALSE)$statistic)})
  p_val <- (sum(abs(W_perm - mu_w) >= abs(W_real - mu_w)) + 1) / (B + 1)
  list(W = W_real, p = p_val, n = n, mean_diff = mean(diffs, na.rm = TRUE))}

mannwhitney_perm_test <- function(df, var, group_var = "Group2", g1, g2, B = 5000) {
  df <- df[!is.na(df[[var]]) & !is.na(df[[group_var]]), c(var, group_var)]
  x <- df[[var]][df[[group_var]] == g1]
  y <- df[[var]][df[[group_var]] == g2]
  n1 <- length(x)
  n2 <- length(y)
  combined <- c(x, y)
  ranks <- rank(combined, ties.method = "average")
  R1 <- sum(ranks[1:n1])
  R2 <- sum(ranks[(n1+1):(n1+n2)])
  U1 <- n1*n2 + n1*(n1+1)/2 - R1
  U2 <- n1*n2 + n2*(n2+1)/2 - R2
  U_real <- min(U1, U2)  
  mu_u <- n1*n2/2  
  u_perm <- numeric(B)
  total_n <- n1 + n2
  for(i in 1:B) {perm_sample <- sample(combined, total_n, replace = FALSE)
    ranks_perm <- rank(perm_sample, ties.method = "average")
    R1p <- sum(ranks_perm[1:n1])
    R2p <- sum(ranks_perm[(n1+1):total_n])
    U1p <- n1*n2 + n1*(n1+1)/2 - R1p
    U2p <- n1*n2 + n2*(n2+1)/2 - R2p
    u_perm[i] <- min(U1p, U2p)}
  p_val <- (sum(abs(u_perm - mu_u) >= abs(U_real - mu_u)) + 1) / (B + 1)
  r_rb <- abs(2*U_real/(n1*n2) - 1) # rank-biserial correlation 
  list(U = U_real, p = p_val, n1 = n1, n2 = n2, r_rb = r_rb)}

kruskal_perm_test <- function(data, var, group_var = "Group2", B = 5000) {
  f <- as.formula(paste(var, "~", group_var))
  kw <- kruskal.test(f, data = data)
  n <- sum(!is.na(data[[var]]))
  k <- length(unique(na.omit(data[[group_var]])))
  eta2 <- (kw$statistic - (k - 1)) / (n - 1)  
  if (eta2 < 0) eta2 <- 0 
  perm_stats <- replicate(B, {data_perm <- data
    data_perm[[group_var]] <- sample(data_perm[[group_var]])
    kruskal.test(f, data = data_perm)$statistic})
  
  p_value <- mean(perm_stats >= kw$statistic)  
  if (p_value == 0) p_value <- 1/(B+1)  
  sig <- p_value < 0.05
  res <- list(var = var, kw_stat = kw$statistic, kw_p = p_value, sig = sig,
              groups = unique(data[[group_var]]),eta2 = as.numeric(eta2))
  
  if (sig && length(res$groups) >= 2) {pairs <- combn(res$groups, 2, simplify = FALSE)
    pair_results <- list()
    for (i in seq_along(pairs)) {p <- pairs[[i]]
      test <- mannwhitney_perm_test(data, var, g1 = p[1], g2 = p[2], B = B)
      pair_results[[i]] <- list(pair = paste(p[1], p[2], sep = " vs "),U = test$U,raw_p = test$p,
                                n1 = test$n1,n2 = test$n2)}
    raw_ps <- sapply(pair_results, function(x) x$raw_p)
    adj_ps_bonf <- p.adjust(raw_ps, method = "bonferroni")
    adj_ps_fdr  <- p.adjust(raw_ps, method = "fdr")
    for (i in seq_along(pair_results)) {pair_results[[i]]$p_raw  <- raw_ps[i]
      pair_results[[i]]$p_fdr  <- adj_ps_fdr[i]
      pair_results[[i]]$p_bonf <- adj_ps_bonf[i]
      pair_results[[i]]$sig <- adj_ps_bonf[i] < 0.05}
    res$pairwise <- pair_results}
  return(res)}

print_kw_result <- function(res) {
  cat("\n", rep("=", 50), "\n", sep = "")
  cat("Variable:", res$var, "\n")
  cat(rep("-", 50), "\n", sep = "")
  cat(sprintf("Kruskal-Wallis test: H = %.2f, p = %.4f, eta² = %.3f", res$kw_stat, res$kw_p, res$eta2))
  cat("sample size of groups: ")
  group_counts <- table(main_data$Group2[!is.na(main_data[[res$var]])])
  cat(paste(names(group_counts), "=", group_counts, collapse = ", "), "\n")
  if (res$sig && !is.null(res$pairwise)) {cat("\n post-hoc (Raw / FDR / Bonferroni correction):\n")
    cat(rep("-", 50), "\n", sep = "")
    for (p in res$pairwise) {sig_symbol <- ifelse(p$sig, "*", "")
      cat(sprintf("%-20s: U = %6.1f, raw_p = %6.4f, FDR_p = %6.4f, Bonf_p = %6.4f%s\n",
                  p$pair, p$U, p$p_raw, p$p_fdr, p$p_bonf, sig_symbol))}}
  cat(rep("=", 50), "\n\n", sep = "")}
```

## statistics for description
```{r Table 2&S1&S2}
main_data$Group2 <- ifelse(main_data$Group %in% c("NS_BA", "NS_WD"), "NS", main_data$Group)
main_data$PANSS_Positive_ave <- main_data$`PANSS_P1.+.P3.(psychotic)`/2
main_data$PANSS_Negative_ave <- (main_data$`PANSS_N2.+.N4.(withdrawal)` + main_data$`PANSS_N1.(blunted.affect)`) /3

results <- list()
for (var in c("Gender(1m2f)", "Education(1a2b)", "NumDrugs")) {
  res <- chi_square_perm_test(main_data, var, B = 5000)
  print_chi_result(res)
  results[[var]] <- res}

for (g in c("PS", "NS")) {
  group_data <- subset(main_data, Group2 == g)
  group_data <- group_data[!is.na(group_data$PANSS_Positive_ave) & !is.na(group_data$PANSS_Negative_ave), ]
  res <- wilcoxon_perm_test(group_data, "PANSS_Positive_ave", "PANSS_Negative_ave")
  cat("====", g, "  PANSS Posi_2items_ave vs Nega_3items_ave ====\n")
  cat("W-value =", round(res$W, 3), "\n")
  cat("p-value =", format.pval(res$p, digits = 4, eps = 0.0001), "\n")
}

for (var in c("PANSS_Positive_ave", "PANSS_Negative_ave", "PANSS_Total")) {
  res <- mannwhitney_perm_test(main_data, var, g1 = "PS", g2 = "NS")
  cat("Variable:", var, "| U =", round(res$U, 2), 
      "| p =", format.pval(res$p, digits = 4, eps = 0.0001),
      "| ES =", round(res$r_rb, 3), "\n")}

for (var in c("OZP(mg/day)", "PANSS_Total", "PANSS_Positive", "PANSS_Negative", 
              "PosiDimension", "NegaDimension", "PANSS_P1.+.P3.(psychotic)", 
              "PANSS_N2.+.N4.(withdrawal)", "PANSS_N1.(blunted.affect)", "RSESE")) {
  res <- mannwhitney_perm_test(main_data, var, g1 = "PS", g2 = "NS")
  cat("Variable:", var, "| U =", round(res$U, 2), 
      "| p =", format.pval(res$p, digits = 4, eps = 0.0001),
      "| n(PS) =", res$n1, "| n(NS) =", res$n2, "| ES =", round(res$r_rb, 3), "\n")}

for (var in c("Age", "IRI_Fantasy", "IRI_EmpathicConcern", "IRI_Perspective",  
               "IRI_PersonalDistress", "UCLA", "PSP", "LSAS_Anxiety", "LSAS_Avoidance",
               "SQLS_MotivationEnergy", "SQLS_SymptomSideeffect", "SQLS_PsychosocialFacet", 
               "Token.Motor.Task", "Digit.Symbol.Test", "Digit.Span.Test_sequence", 
               "Digit.Span.Test_reverse", "Digit.Span.Test_sum",  "RDearlier_scaled", "WSearlier_scaled", 
               "IC_scaled", "WS_scaled", "FirstTappingIC", "FirstTappingWS",
               "QuestionnaireIC", "QuestionnaireWS")) {
  res <- kruskal_perm_test(main_data, var)
  print_kw_result(res)}
```

## Correlation of bahavior and symptoms
```{r Text1, results='asis'}
target_vars <- c("IC_scaled", "WS_scaled")
other_vars <- c("IRI_Fantasy", "IRI_EmpathicConcern", "IRI_Perspective",
  "IRI_PersonalDistress", "UCLA", "PSP", "LSAS_Anxiety", "LSAS_Avoidance",
  "SQLS_MotivationEnergy", "SQLS_SymptomSideeffect", "SQLS_PsychosocialFacet",
  "Token.Motor.Task", "Digit.Symbol.Test", "Digit.Span.Test_sequence",
  "Digit.Span.Test_reverse", "Digit.Span.Test_sum")

group_sets <- list("Group1" = c(1),"Group2" = c(2),"Group3" = c(3),"Group2_3" = c(2, 3))
plot_data <- data.frame(
  Group = character(),Target = character(),Variable = character(),
  r = numeric(),ci_low = numeric(),ci_high = numeric(),stringsAsFactors = FALSE)

for (grp_name in names(group_sets)) {
  g_vals <- group_sets[[grp_name]]
  group_data <- main_data %>% filter(Group2 %in% g_vals)
  cat("\n=============================\n")
  cat("Group:", grp_name, " (Group2 in", paste(g_vals, collapse = ","), ")\n")
  cat("=============================\n")
  for (tvar in target_vars) {
    cat("\n--", tvar, "--\n")
    all_results <- list()
    var_names <- c()
    for (ovar in other_vars) {
      temp_data <- group_data[, c(tvar, ovar)]
      temp_data <- temp_data[complete.cases(temp_data), ]
      if (nrow(temp_data) > 2) { 
        test <- cor.test(temp_data[[tvar]], temp_data[[ovar]], method = "pearson")
        ci_low <- test$conf.int[1]
        ci_high <- test$conf.int[2]
        all_results[[length(all_results) + 1]] <- list(
          variable = ovar, r = test$estimate,
          p_raw = test$p.value, n = nrow(temp_data),
          ci_low = ci_low, ci_high = ci_high)
      } else {
        all_results[[length(all_results) + 1]] <- list(
          variable = ovar, r = NA, p_raw = NA, n = 0,
          ci_low = NA, ci_high = NA)}}
    p_raw <- sapply(all_results, function(x) x$p_raw)
    p_fdr <- p.adjust(p_raw, method = "fdr")
    p_bonf <- p.adjust(p_raw, method = "bonferroni")
    
    for (i in 1:length(all_results)) {
      result <- all_results[[i]]
      if (!is.na(result$r) && result$n > 2) {
        cat(sprintf("%-25s r = %6.3f, 95%% CI = [%.3f, %.3f], n = %2d, p_raw = %.4f, p_fdr = %.4f, p_bonf = %.4f\n",result$variable, result$r, result$ci_low, result$ci_high,result$n, result$p_raw, p_fdr[i], p_bonf[i]))

        plot_data <- rbind(plot_data, data.frame(
            Group = grp_name,Target = tvar,Variable = result$variable,
            r = result$r,ci_low = result$ci_low,ci_high = result$ci_high))
      } else {cat(sprintf("%-25s data default\n", result$variable))}}}
  cat("\n")}

plot_data_sig <- plot_data %>%
  dplyr::filter(!is.na(ci_low) & ci_low * ci_high > 0)   
# 画图思路参考：Di Stefano, J. (2004). A confidence interval approach to data analysis. Forest Ecology and Management, 187(2-3), 173-183.
if (nrow(plot_data_sig) > 0) {
  plot_data_sig$Group <- factor(plot_data_sig$Group,
                                levels = c("Group1", "Group2", "Group3", "Group2_3"),
                                labels = c("HC", "PS", "NS", "PS+NS"))
  group_colors <- c("HC" = "#66c2a5","PS" = "#fc8d62","NS" = "#8da0cb","PS+NS" = "#b78fa0")
  
  plot_data_sig$combo <- interaction(plot_data_sig$Group, plot_data_sig$Target, plot_data_sig$Variable)
  plot_data_sig$Target_clean <- ifelse(grepl("IC", plot_data_sig$Target), "IC", "WS")
  combo_labels <- plot_data_sig %>%
    distinct(combo, Target_clean) %>%
    arrange(combo)
  
  p <- ggplot(plot_data_sig,aes(x = combo, y = r, color = Group)) +
    geom_point(size = 3, position = position_dodge(width = 0.6)) +
    geom_errorbar(aes(ymin = ci_low, ymax = ci_high),width = 0.25, position = position_dodge(width = 0.6)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.6) +
    scale_color_manual(values = group_colors) +
    scale_y_continuous(limits = c(-1, 1), expand = c(0.02, 0.02)) +
    scale_x_discrete(labels = combo_labels$Target_clean) +
    labs(y = "Pearson's r", x = NULL, color = "Group") +
    theme_minimal(base_size = 13) +
    theme(panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 0, hjust = 1, color = "black"),
      axis.text.y = element_text(color = "black"),
      axis.title = element_text(color = "black"),
      axis.line = element_line(color = "black", linewidth = 0.8),
      axis.ticks = element_line(color = "black"),
      plot.title = element_text(face = "bold", hjust = 0.5),
      legend.position = "top",
      legend.title = element_text(face = "bold")) + 
    geom_rect(xmin = 0.7, xmax = 3.3, ymin = -0.05, ymax = 0,fill = "grey", alpha = 1, color = NA)+
    geom_rect(xmin = 3.7, xmax = 5.3, ymin = -0.05, ymax = 0,fill = "grey", alpha = 1, color = NA)+
    geom_rect(xmin = 5.7, xmax = 8.3, ymin = -0.05, ymax = 0,fill = "grey", alpha = 1, color = NA)
  ggsave(filename = "C:/Users/XinHao/Desktop/2025_SCZ_AI/empirical_data/EmpiricalPlot_Correlation.png",
         plot = p, width = 6, height = 6, dpi = 600, bg = "white")
  print(p)}
```

## Draw symptom plots
```{r Figure3 A-C, results='asis'}
main_data$`PANSS_P1.+.P3.(psychotic)` <- as.numeric(main_data$`PANSS_P1.+.P3.(psychotic)`)
main_data$`PANSS_N2.+.N4.(withdrawal)` <- as.numeric(main_data$`PANSS_N2.+.N4.(withdrawal)`)
main_data$`PANSS_N1.(blunted.affect)` <- as.numeric(main_data$`PANSS_N1.(blunted.affect)`)
main_data$PANSS_Total <- as.numeric(main_data$PANSS_Total)
data <- data.frame( 
  "A" = c(main_data$`PANSS_P1.+.P3.(psychotic)`[25:32], 0,  main_data$`PANSS_P1.+.P3.(psychotic)`[25:32], main_data$`PANSS_P1.+.P3.(psychotic)`[17:24]),
  "B" = c(main_data$`PANSS_N2.+.N4.(withdrawal)`[25:32], 0,  main_data$`PANSS_N2.+.N4.(withdrawal)`[25:32],main_data$`PANSS_N2.+.N4.(withdrawal)`[17:24]),
  "C" = c(main_data$`PANSS_N1.(blunted.affect)`[25:32]*2, 0,  main_data$`PANSS_N1.(blunted.affect)`[25:32]*2, main_data$`PANSS_N1.(blunted.affect)`[17:24]*2))
data$Group <- c(rep("BA", 4), rep("WD",4), rep('NA', 1), rep("NS", 8), rep("PS", 8))
data_long <- data %>%
  pivot_longer(cols = -Group, names_to = "Metric", values_to = "Value")
summary_data <- data_long %>%
  group_by(Metric, Group) %>%
  summarise(mean = mean(Value), n=n(), se = sd(Value)/sqrt(n()), .groups = 'drop')
summary_data$se[summary_data$Group %in% c("BA", "WD")] <- NA  #no errorbar in subgroups
levels(summary_data$Metric) <- c("A", "B", "C")
summary_data$Group <- factor(summary_data$Group, levels = c('BA','WD','NA','NS','PS'))
data_long$Group <- factor(data_long$Group, levels = c('BA','WD','NA','NS','PS'))
summary_data$Metric <- factor(summary_data$Metric, levels = c("A", "B", "C"))
SymptomsRaw <- ggplot(summary_data, aes(x = Group, y = mean, fill = Metric)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), width = 0.7, colour = NA) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.4, position = position_dodge(width = 0.9), linewidth = 0.7, na.rm = TRUE) + 
  geom_jitter(data = subset(data_long, Group != 'NA'), aes(x = Group, y = Value), 
              position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.7), alpha = 1, color = 'black', size = 1) + 
  scale_fill_manual(values = c('#fc8d62','#8da0cb','#6495ed'), name = "Items", labels = c("P1+P3", "N2+N4", "2N1")) + 
  scale_x_discrete(breaks = c('PS','NS','BA','WD'), labels = c('PS', 'NS', 'BA', 'WD')) + 
  coord_cartesian(ylim = c(0, 10)) +
  labs(x = NULL, y = "Raw Scores") +
  theme_prism(axis_text_angle = 0)+ 
  theme(legend.direction = "vertical", legend.position = 'right',
        axis.line = element_line(color = 'black', size = 0.75),
        axis.ticks = element_line(color = 'black', size = 0.75),
        axis.text = element_text(size = 12, color = "black", face = 'plain'),  
        axis.title = element_text(size = 14, face = 'plain')) +
  geom_rect(aes(xmin=0.5, xmax=2.5,ymin=-0.2,ymax=10.45), fill = NA, color='black', linetype = 'dashed', size=0.75) + 
  geom_rect(aes(xmin=3.5, xmax=4.5,ymin=-0.2,ymax=10.45), fill = NA, color='black', linetype = 'dashed', size=0.75)
ggsave(filename = file.path(basepath, "EmpiricalPlot_SymptomsRaw.png"),  width = 6, height = 4, dpi = 500)
print(SymptomsRaw)

data <- data.frame( 
  "A" = c(main_data$`PANSS_P1.+.P3.(psychotic)`[17:24]/(2*main_data$PANSS_Total[17:24]), 0,  main_data$`PANSS_P1.+.P3.(psychotic)`[25:32]/(2*main_data$PANSS_Total[25:32])),
  "B" = c((main_data$`PANSS_N2.+.N4.(withdrawal)`[17:24] + main_data$`PANSS_N1.(blunted.affect)`[17:24])/(3*main_data$PANSS_Total[17:24]), 
          0, (main_data$`PANSS_N2.+.N4.(withdrawal)`[25:32] + main_data$`PANSS_N1.(blunted.affect)`[25:32])/(3*main_data$PANSS_Total[25:32])))
data$Group <- c(rep("PS", 8), rep('NA', 1), rep("NS", 8))
data_long <- data %>%
  pivot_longer(cols = -Group, names_to = "Metric", values_to = "Value")
summary_data <- data_long %>%
  group_by(Metric, Group) %>%
  summarise(mean = mean(Value), n=n(), se = sd(Value)/sqrt(n()), .groups = 'drop')
levels(summary_data$Metric) <- c("A", "B")
summary_data$Group <- factor(summary_data$Group, levels = c('PS','NA','NS'))
data_long$Group <- factor(data_long$Group, levels = c('PS','NA','NS'))
summary_data$Metric <- factor(summary_data$Metric, levels = c("A", "B"))
SymptomsRelative <- ggplot(summary_data, aes(x = Group, y = mean, fill = Metric)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), width = 0.7, colour = NA) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.4, position = position_dodge(width = 0.9), linewidth = 0.7, na.rm = TRUE) + 
  geom_jitter(data = subset(data_long, Group != 'NA'), aes(x = Group, y = Value), 
              position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.7), alpha = 1, color = 'black', size = 1) + 
  scale_fill_manual(values = c('#fc8d62','#4169E1'), name = "Items", labels = c("(P1+P3)/2", "(N2+N4+N1)/3")) + 
  scale_x_discrete(breaks = c('PS','NS'), labels = c('PS', 'NS')) + 
  coord_cartesian(ylim = c(0, 0.08)) +
  labs(x = NULL, y = "Relative Scores") +
  theme_prism(axis_text_angle = 0)+ 
  theme(legend.direction = "vertical", legend.position = 'right',
        axis.line = element_line(color = 'black', size = 0.75),
        axis.ticks = element_line(color = 'black', size = 0.75),
        axis.text = element_text(size = 12, color = "black", face = 'plain'),  
        axis.title = element_text(size = 14, face = 'plain')) 
ggsave(filename = file.path(basepath, "EmpiricalPlot_SymptomsRelative.png"),  width = 5, height = 4, dpi = 500)
print(SymptomsRelative)

data <- data.frame("PANSS_Total" = c(main_data$PANSS_Total[25:32], main_data$PANSS_Total[17:24]),
  "Group" = c(rep("PS", 8), rep("NS", 8)))
data_long <- data %>%
  pivot_longer(cols = -Group, names_to = "Metric", values_to = "Value")
summary_data <- data_long %>%
  group_by(Metric, Group) %>%
  summarise(mean = mean(Value), n = n(), se = sd(Value)/sqrt(n()), .groups = 'drop')
summary_data$Group <- factor(summary_data$Group, levels = c('PS', 'NS'))
data_long$Group <- factor(data_long$Group, levels = c('PS', 'NS'))
PANSS_Total_Plot <- ggplot(summary_data, aes(x = Group, y = mean, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), width = 0.7, colour = NA) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.4, position = position_dodge(width = 0.9), 
                linewidth = 0.7, na.rm = TRUE) + 
  geom_jitter(data = data_long, aes(x = Group, y = Value, fill = Group), position = position_jitter(width = 0.2), 
              alpha = 1, fill = 'black', color = 'black', size = 1.5, shape = 21) + 
  scale_fill_manual(values = c('PS' = '#fc8d62', 'NS' = '#4169E1'), name = "Group", labels = c('PS', 'NS')) + 
  scale_x_discrete(labels = c('PS', 'NS')) + 
  coord_cartesian(ylim = c(0, 100)) +
  labs(x = NULL, y = "PANSS Total Score") +
  theme_minimal() +
  theme(legend.position = 'none', 
    axis.line = element_line(color = 'black', size = 0.75),
    axis.ticks = element_line(color = 'black', size = 0.75),
    axis.text = element_text(size = 12, color = "black", face = 'plain'),  
    axis.title = element_text(size = 14, face = 'plain'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank())
ggsave(filename = file.path(basepath, "EmpiricalPlot_PANSSTotal.png"), width = 1.5, height = 4, dpi = 500)
print(PANSS_Total_Plot)
```

## Draw behavior bar-plots
```{r Figure 3D-G, results='asis'}
plot_empirical <- function(data_column, y_label, file_name) {
  data <- data.frame(
    group = factor(c(rep('HC',16), rep('PS',8), rep('NS',8)),
            levels = c('HC','PS','NS')),
    exp = c(main_data[[data_column]][1:16], main_data[[data_column]][17:24],
            main_data[[data_column]][25:32]))
  p <- ggplot(data = data, mapping = aes(x = factor(group), y = exp, fill = group)) +
    stat_summary(fun = "mean", geom = "bar", width = 0.7, colour = NA, size = 0.9) +
    geom_jitter(data = subset(data, group != 'NA'), size = 1) +
    stat_summary(fun = "mean", fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                 fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                 geom = "errorbar", width = 0.4, size = 0.7) +
    theme_prism(axis_text_angle = 0) +
    theme(legend.direction = "vertical",
          axis.line = element_line(color = 'black', size = 0.75),
          axis.ticks = element_line(color = 'black', size = 0.75),
          axis.text = element_text(size = 12, color = "black", face = 'plain'),
          axis.title = element_text(size = 14, face = 'plain')) +
    coord_cartesian(ylim = c(0, 1.05)) +
    scale_fill_manual(values = c('#66c2a5','#fc8d62','#8da0cb')) +
    scale_x_discrete(breaks = c('HC','PS','NS'), labels = c('HC','PS','NS')) +
    labs(x = NULL, y = y_label) 
  ggsave(filename = file.path(basepath, file_name), plot = p, width = 4, height = 4, dpi = 500)
  print(p)
}

plot_empirical("IC_scaled", "IC", "EmpiricalPlot_IC.png")
plot_empirical("WS_scaled", "WS", "EmpiricalPlot_WS.png")
plot_empirical("WSearlier_scaled", "WS with metronome", "EmpiricalPlot_WSearlier.png")
plot_empirical("RDearlier_scaled", "RD with metronome", "EmpiricalPlot_RDearlier.png")
```
## Draw subgroups behavior bar-plots
```{r Figure S3A, results='asis'}
plot_empirical <- function(data_column, y_label, file_name) {
  data <- data.frame(
    group = factor(c(rep('BA',4), rep('WD',4)),
            levels = c('BA','WD')),
    exp = c(main_data[[data_column]][25:28], main_data[[data_column]][29:32]))
  p <- ggplot(data = data, mapping = aes(x = factor(group), y = exp, fill = group)) +
    stat_summary(fun = "mean", geom = "bar", width = 0.7, colour = NA, size = 0.9) +
    geom_jitter(data = subset(data, group != 'NA'), size = 1) +
    stat_summary(fun = "mean", fun.max = function(x) mean(x) + sd(x),
                 fun.min = function(x) mean(x) - sd(x), geom = "errorbar", width = 0.4, size = 0.7) +
    theme_prism(axis_text_angle = 0) +
    theme(legend.direction = "vertical",
          axis.line = element_line(color = 'black', size = 0.75),
          axis.ticks = element_line(color = 'black', size = 0.75),
          axis.text = element_text(size = 12, color = "black", face = 'plain'),
          axis.title = element_text(size = 14, face = 'plain')) +
    coord_cartesian(ylim = c(0, 1.05)) +
    scale_fill_manual(values = c('#e78ac3','#a6d854')) +
    scale_x_discrete(breaks = c('BA','WD'), labels = c('BA','WD')) +
    labs(x = NULL, y = y_label) 
  ggsave(filename = file.path(basepath, file_name), plot = p, width = 4, height = 4, dpi = 500)
  print(p)
}

plot_empirical("IC_scaled", "IC", "EmpiricalSubPlot_IC_.png")
plot_empirical("WS_scaled", "WS", "EmpiricalSubPlot_WS.png")
plot_empirical("WSearlier_scaled", "WS with metronome", "EmpiricalSubPlot_WSearlier.png")
plot_empirical("RDearlier_scaled", "RD with metronome", "EmpiricalSubPlot_RDearlier.png")
```


## Draw hidden state probability
```{r Figure 5A, results='asis'}
hiddenstateprobs <- read.csv("C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/hiddenstateprobs.csv")
group_colors <- c('HC' = '#66c2a5','PS' = '#fc8d62','NS' = '#8da0cb','BA' = '#e78ac3','WD' = '#a6d854')
plot_hidden_state <- function(data, groups) {
  data_filtered <- data %>%
    filter(group %in% groups) %>%
    mutate(group = as.factor(group))
  ggplot(data_filtered, aes(x = t, y = probability, color = group)) +
    geom_line() +
    scale_color_manual(values = group_colors) +
    geom_hline(yintercept = 0.5, linetype = "dotted", color = "black") +
    facet_wrap(~ state, ncol = 1) +
    labs(x = "Timepoint", y = "Hidden State Probability") +
    scale_x_continuous(breaks = seq(1, 24, by = 1)) +
    scale_y_continuous(limits = c(0.4, 1), breaks = seq(0.4, 1, by = 0.1)) +
    theme_minimal(base_size = 18) +
    theme(legend.position = "none")}
p1 <- plot_hidden_state(hiddenstateprobs, c("HC", "PS", "NS"))
p2 <- plot_hidden_state(hiddenstateprobs, c("BA", "WD"))
combined_plot <- p1 + p2 + plot_layout(ncol = 2)
print(combined_plot)
ggsave("C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/SimulatedPlot_HiddenState.png", combined_plot, width = 16, height = 8, dpi = 300)

summary_stats_all <- hiddenstateprobs %>%
  group_by(group, state) %>%
  summarise(n = sum(!is.na(probability)),
    mean = mean(probability, na.rm = TRUE),
    sd = sd(probability, na.rm = TRUE)) %>%
  arrange(state, group)
print(summary_stats_all)

hiddenstateprobs_sub <- hiddenstateprobs %>%
  filter(group %in% c("HC", "PS", "NS")) %>%
  mutate(Grouphidden = factor(group, levels = c("HC", "PS", "NS")))
states <- unique(hiddenstateprobs_sub$state)
results <- list()
for (st in states) {
  dat_sub <- hiddenstateprobs_sub %>% filter(state == st)
  fit <- aov(probability ~ Grouphidden, data = dat_sub)
  anova_res <- summary(fit)[[1]]
  F_val <- anova_res$`F value`[1]
  p_val <- anova_res$`Pr(>F)`[1]
  em <- emmeans(fit, specs = "Grouphidden")
  pairwise_raw <- pairs(em, adjust = "none") |> as.data.frame()
  pairwise_bonf <- pairs(em, adjust = "bonferroni") |> as.data.frame()
  pairwise_df <- pairwise_raw %>%
    dplyr::select(contrast, estimate, SE, df, t.ratio, p.value) %>%
    rename(p_uncorrected = p.value) %>%
    left_join(pairwise_bonf %>%
        dplyr::select(contrast, p.value) %>%
        rename(p_bonferroni = p.value),by = "contrast") %>%
    mutate(across(c(estimate, SE, df, t.ratio, p_uncorrected, p_bonferroni), ~ round(.x, 4)))
  results[[st]] <- list(state = st,ANOVA_F = F_val,ANOVA_p = round(p_val, 4),pairwise = pairwise_df)}

for (st in names(results)) {
  cat("\n====", st, "====\n")
  cat("ANOVA: F =", results[[st]]$ANOVA_F, ", p =", results[[st]]$ANOVA_p, "\n")
  cat("\n post-hoc:\n")
  print(results[[st]]$pairwise)
}
```



## Draw bar-plot of single shot simulation
```{r Figure 5B-C, results='asis'}
file_path <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/"
group_levels <- c("HC", "PS", "NS")
fill_colors <- c('#66c2a5','#fc8d62','#8da0cb')
plot_metric <- function(metric_name, empirical_values, filename, ylim_max) {
  emp_data <- data.frame(
    group = factor(rep(group_levels, times = c(16,8,8)), levels = group_levels),
    exp = empirical_values)
  emp_summary <- emp_data %>%
    group_by(group) %>%
    summarise(Mean = mean(exp, na.rm=TRUE), SD = sd(exp, na.rm=TRUE))
  emp_summary[emp_summary$group == "NA", "SD"] <- 0
  print(emp_summary[, c("group", "Mean", "SD")])
  
  sim_data <- read_csv(paste0(file_path, 'simulated_performance_ss26Aug2025.csv')) %>%
    filter(group %in% group_levels) %>%
    mutate(group = factor(group, levels = group_levels))
  
  data_summary <- sim_data %>%
    filter(group %in% c("HC", "PS", "NS")) %>%
    group_by(group) %>%
    summarise(mean_bar = mean(.data[[metric_name]], na.rm = TRUE), .groups = "drop")
  data_summary <- data_summary[1:3, ]
  data_summary$group <- factor(data_summary$group, levels = group_levels)
  
  p <- ggplot(data = data_summary, aes(x = group, y = mean_bar, fill = group)) +
    geom_bar(stat = 'identity', position = 'dodge', width = 0.7) +
    geom_point(data = subset(emp_summary, group != 'NA'), aes(x = group, y = Mean, fill = group), size = 1.25) +
    geom_errorbar(data = subset(emp_summary, group != 'NA'), 
                  aes(x = group, ymin = Mean - SD, ymax = Mean + SD), 
                  inherit.aes = FALSE, width = 0.4, size = 0.5, color = "black") +
    theme_prism(axis_text_angle = 0) +
    theme(legend.direction = "vertical",
      axis.line = element_line(color = 'black', size = 0.75),
      axis.ticks = element_line(color = 'black', size = 0.75),
      axis.text = element_text(size = 12, color = "black", face = 'plain'),
      axis.title = element_text(size = 14, face = 'plain')) +
    coord_cartesian(ylim = c(0, ylim_max)) +
    scale_fill_manual(values = fill_colors) +
    scale_x_discrete(breaks = c("HC", "PS", "NS"), labels = c("HC", "PS", "NS")) +
    labs(x = NULL, y = metric_name) 
  ggsave(filename = file.path(file_path, filename), plot = p, width = 4, height = 4, dpi = 500)
  print(p)
}
emp_values_IC <- c(main_data$IC_scaled[1:16], main_data$IC_scaled[17:24], main_data$IC_scaled[25:32])
plot_metric("IC", emp_values_IC, "SimulatedPlot_SS_IC.png", ylim_max = 1)
emp_values_WS <- c(main_data$WS_scaled[1:16], main_data$WS_scaled[17:24], main_data$WS_scaled[25:32])
plot_metric("WS", emp_values_WS, "SimulatedPlot_SS_WS.png", ylim_max = 1)
```

## Draw subgroup bar-plot of single shot simulation
```{r Figure S3B, results='asis'}
file_path <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/"
group_levels <- c("BA", "WD")
fill_colors <- c('#e78ac3','#a6d854')
plot_metric <- function(metric_name, empirical_values, filename, ylim_max) {
  emp_data <- data.frame(
    group = factor(rep(group_levels, times = c(4,4)), levels = group_levels),
    exp = empirical_values)
  emp_summary <- emp_data %>%
    group_by(group) %>%
    summarise(Mean = mean(exp, na.rm=TRUE), SD = sd(exp, na.rm=TRUE))
  emp_summary[emp_summary$group == "NA", "SD"] <- 0
  print(emp_summary[, c("group", "Mean", "SD")])
  
  sim_data <- read_csv(paste0(file_path, 'simulated_performance_ss26Aug2025.csv')) %>%
    filter(group %in% group_levels) %>%
    mutate(group = factor(group, levels = group_levels))
  
  data_summary <- sim_data %>%
    filter(group %in% c("BA", "WD")) %>%
    group_by(group) %>%
    summarise(mean_bar = mean(.data[[metric_name]], na.rm = TRUE), .groups = "drop")
  data_summary <- data_summary[1:2, ]
  data_summary$group <- factor(data_summary$group, levels = group_levels)
  
  p <- ggplot(data = data_summary, aes(x = group, y = mean_bar, fill = group)) +
    geom_bar(stat = 'identity', position = 'dodge', width = 0.7) +
    geom_point(data = subset(emp_summary, group != 'NA'), aes(x = group, y = Mean, fill = group), size = 1.25) +
    geom_errorbar(data = subset(emp_summary, group != 'NA'), 
                  aes(x = group, ymin = Mean - SD, ymax = Mean + SD), 
                  inherit.aes = FALSE, width = 0.4, size = 0.5, color = "black") +
    theme_prism(axis_text_angle = 0) +
    theme(legend.direction = "vertical",
      axis.line = element_line(color = 'black', size = 0.75),
      axis.ticks = element_line(color = 'black', size = 0.75),
      axis.text = element_text(size = 12, color = "black", face = 'plain'),
      axis.title = element_text(size = 14, face = 'plain')) +
    coord_cartesian(ylim = c(0, ylim_max)) +
    scale_fill_manual(values = fill_colors) +
    scale_x_discrete(breaks = c("BA", "WD"), labels = c("BA", "WD")) +
    labs(x = NULL, y = metric_name) 
  ggsave(filename = file.path(file_path, filename), plot = p, width = 4, height = 4, dpi = 500)
  print(p)
}
emp_values_IC <- c(main_data$IC_scaled[25:28], main_data$IC_scaled[29:32])
plot_metric("IC", emp_values_IC, "SimulatedSubPlot_SS_IC.png", ylim_max = 1)
emp_values_WS <- c(main_data$WS_scaled[25:28], main_data$WS_scaled[29:32])
plot_metric("WS", emp_values_WS, "SimulatedSubPlot_SS_WS.png", ylim_max = 1)
```

## Draw violin-plot of Gaussian simulation
```{r Figure 5D-E, results='asis'}
file_path <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/"
group_levels <- c("HC", "PS", "NS")
fill_colors <- c('#66c2a5','#fc8d62','#8da0cb')
plot_metric_violin <- function(metric_name, empirical_values, filename, ylim_max) {
    emp_data <- data.frame(
        Group = factor(rep(group_levels, times = c(16,8,8)), levels = group_levels),
        exp = empirical_values)
    emp_summary <- emp_data %>%
        group_by(Group) %>%
        summarise(Mean = mean(exp, na.rm=TRUE), SD = sd(exp, na.rm=TRUE), .groups="drop") 
    emp_summary[emp_summary$Group == "NA", "SD"] <- 0
    print(emp_summary[, c("Group","Mean","SD")])
    
    sim_data <- read_csv(paste0(file_path, 'nd_sim_26aug.csv')) %>%
        filter(Group %in% group_levels) %>%
        mutate(Group = factor(Group, levels = group_levels))
    
    if(!"NA" %in% sim_data$Group){
        sim_data <- sim_data %>% add_row(Group=factor("NA", levels=group_levels))}
    
    p <- ggplot(data = sim_data, aes(x = Group, y = .data[[metric_name]], fill = Group)) +
        geom_violin(trim=FALSE, width=1, color=NA, adjust = 2) +
        geom_point(data = subset(emp_summary, Group != "NA"), aes(x = Group, y = Mean), size=1.25) +
        geom_errorbar(data = subset(emp_summary, Group != "NA"), aes(x=Group, ymin=Mean-SD, ymax=Mean+SD),
                      inherit.aes = FALSE, width=0.4, size=0.5, color="black") +
        theme_prism(axis_text_angle=0) +
        theme(legend.direction="vertical",
            axis.line=element_line(color='black', size=0.75),
            axis.ticks=element_line(color='black', size=0.75),
            axis.text=element_text(size=12, color="black", face='plain'),
            axis.title=element_text(size=14, face='plain')) +
        coord_cartesian(ylim=c(0, ylim_max)) +
        scale_fill_manual(values = setNames(fill_colors, group_levels)) +
        scale_x_discrete(breaks=c("HC","PS","NS"), labels=c("HC","PS","NS")) +
        labs(x=NULL, y=metric_name) 
    ggsave(filename=file.path(file_path, filename), plot=p, width=5, height=4, dpi=500)
    print(p)
}

emp_values_IC <- c(main_data$IC_scaled[1:16], main_data$IC_scaled[17:24], main_data$IC_scaled[25:32])
plot_metric_violin("IC", emp_values_IC, "SimulatedPlot_ND_IC.png", ylim_max=1)
emp_values_WS <- c(main_data$WS_scaled[1:16], main_data$WS_scaled[17:24], main_data$WS_scaled[25:32])
plot_metric_violin("WS", emp_values_WS, "SimulatedPlot_ND_WS.png", ylim_max=1)
```
## Draw subgroup violin-plot of Gaussian simulation
```{r Figure S3C, results='asis'}
file_path <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/"
group_levels <- c("BA", "WD")
fill_colors <- c('#e78ac3','#a6d854')
plot_metric_violin <- function(metric_name, empirical_values, filename, ylim_max) {
    emp_data <- data.frame(
        Group = factor(rep(group_levels, times = c(4,4)), levels = group_levels),
        exp = empirical_values)
    emp_summary <- emp_data %>%
        group_by(Group) %>%
        summarise(Mean = mean(exp, na.rm=TRUE), SD = sd(exp, na.rm=TRUE), .groups="drop") 
    emp_summary[emp_summary$Group == "NA", "SD"] <- 0
    print(emp_summary[, c("Group","Mean","SD")])
    
    sim_data <- read_csv(paste0(file_path, 'nd_sim_26aug.csv')) %>%
        filter(Group %in% group_levels) %>%
        mutate(Group = factor(Group, levels = group_levels))
    
    if(!"NA" %in% sim_data$Group){
        sim_data <- sim_data %>% add_row(Group=factor("NA", levels=group_levels))}
    
    p <- ggplot(data = sim_data, aes(x = Group, y = .data[[metric_name]], fill = Group)) +
        geom_violin(trim=FALSE, width=1, color=NA, adjust = 2) +
        geom_point(data = subset(emp_summary, Group != "NA"), aes(x = Group, y = Mean), size=1.25) +
        geom_errorbar(data = subset(emp_summary, Group != "NA"), aes(x=Group, ymin=Mean-SD, ymax=Mean+SD),
                      inherit.aes = FALSE, width=0.4, size=0.5, color="black") +
        theme_prism(axis_text_angle=0) +
        theme(legend.direction="vertical",
            axis.line=element_line(color='black', size=0.75),
            axis.ticks=element_line(color='black', size=0.75),
            axis.text=element_text(size=12, color="black", face='plain'),
            axis.title=element_text(size=14, face='plain')) +
        coord_cartesian(ylim=c(0, ylim_max)) +
        scale_fill_manual(values = setNames(fill_colors, group_levels)) +
        scale_x_discrete(breaks=c("BA", "WD"), labels=c("BA", "WD")) +
        labs(x=NULL, y=metric_name) 
    ggsave(filename=file.path(file_path, filename), plot=p, width=5, height=4, dpi=500)
    print(p)
}

emp_values_IC <- c(main_data$IC_scaled[25:28], main_data$IC_scaled[29:32])
plot_metric_violin("IC", emp_values_IC, "SimulatedSubPlot_ND_IC.png", ylim_max=1)
emp_values_WS <- c(main_data$WS_scaled[25:28], main_data$WS_scaled[29:32])
plot_metric_violin("WS", emp_values_WS, "SimulatedSubPlot_ND_WS.png", ylim_max=1)
```


## Test best-fit distribution of Gaussian simulation
```{r Table 4C}
data <- read_csv("C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/nd_sim_26aug.csv")
cols_to_test <- c("IC", "WS")
dists <- c("norm", "lnorm", "gamma", "weibull", "exp", "logis", "cauchy",
           "beta", "t", "llogis", "burr", "pareto", "ggamma", "invgauss", "johnson")
for (col in cols_to_test) {
  for (grp in unique(data$Group)) {
    subset_data <- data %>% filter(Group == grp) %>% pull(col)
    subset_data <- subset_data[!is.na(subset_data) & subset_data > 0]
    fit_list <- list()
    for (dist in dists) {
      fit <- tryCatch(fitdist(subset_data, dist), error = function(e) NULL)
      if (!is.null(fit)) fit_list[[dist]] <- fit
    }
    comp <- gofstat(fit_list)
    best_bic <- names(which.min(comp$bic))
    q25 <- quantile(subset_data, 0.25, na.rm = TRUE)
    q50 <- quantile(subset_data, 0.50, na.rm = TRUE)
    q75 <- quantile(subset_data, 0.75, na.rm = TRUE)
    cat("\nGroup:", grp,  "\nIndex:", col, "\n")
    cat("  BIC best-fit distribution:", best_bic, "\n")
    cat("  median =", round(q50, 4), "  25% =", round(q25, 4), "  75% =", round(q75, 4), "\n")
    cat("==============================\n")
  }
}
```

## Correlation analysis between parameters and simulated indices
```{r Figure S1, results='asis'}
file_path <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/"
nd_data <- read_csv(paste0(file_path, 'nd_sim_26aug.csv'))
color_palette <- colorRampPalette(c("#1E3A78", "white", "#B22222"))(200)

correlation_matrices <- list()
pvalue_matrices <- list()
groups <- unique(nd_data$Group)
for (group in groups) {
    group_data <- subset(nd_data, Group == group)
    numeric_data <- group_data[, -1] 
    vars <- colnames(numeric_data)
    cor_matrix <- p_matrix <- matrix(NA, ncol = length(vars), nrow = length(vars), dimnames = list(vars, vars))
    for (i in 1:ncol(numeric_data)) {
        for (j in i:ncol(numeric_data)) {  
            test_result <- cor.test(numeric_data[[i]], numeric_data[[j]], use='pairwise.complete.obs', method='pearson')
            cor_matrix[i, j] <- test_result$estimate
            cor_matrix[j, i] <- test_result$estimate 
            p_matrix[i, j] <- test_result$p.value
            p_matrix[j, i] <- test_result$p.value  }}
    p_matrix_adj <- p.adjust(p_matrix[lower.tri(p_matrix)], method="bonferroni")
    p_matrix[lower.tri(p_matrix)] <- p_matrix_adj
    p_matrix[upper.tri(p_matrix)] <- NA 
    correlation_matrices[[group]] <- cor_matrix
    pvalue_matrices[[group]] <- p_matrix }

plot_corr_with_stars <- function() {
  par(mfrow = c(2, 3), mar = c(2, 0.5, 2, 0.5), oma = c(1, 1, 2, 1))
  for (group in groups) {
    corr_matrix <- correlation_matrices[[group]]
    p_matrix <- pvalue_matrices[[group]]
    corrplot(corr_matrix,method = "color",type = "lower",col = color_palette,addCoef.col = "black",tl.col = "black",tl.srt = 45,number.cex = 0.8,order = "original",diag = FALSE,
             title = paste(group),mar = c(0, 0, 2, 0),addgrid.col = "grey")
    n <- nrow(corr_matrix)
    for (i in 1:n) {
      for (j in 1:n) {
        if (i > j && !is.na(p_matrix[i, j]) && p_matrix[i, j] < 0.05) {
          x_pos <- j + 0.20  # adjust the 'star' place
          y_pos <- n - i + 1 + 0.35
          stars <- ifelse(p_matrix[i, j] < 0.001, "***", ifelse(p_matrix[i, j] < 0.01, "**", "*"))
          text(x_pos, y_pos, stars, cex = 1.2, col = "black", font = 1.5)}}}
    abline(h = 2.5, col = "black", lty = 2, lwd = 1.5)}
  par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1)}
plot_corr_with_stars()
png(filename = file.path(file_path, "SimulatedPlot_CorrHeatmap.png"), width = 2400, height = 1600, res = 300)
plot_corr_with_stars()
dev.off()
```

## GLM analysis
```{r Figure 6, results='asis'}
file_path <- "C:/Users/XinHao/Desktop/2025_SCZ_AI/simulation/"
nd_data <- read_csv(paste0(file_path, 'nd_sim_26aug.csv'))
sub1data <- subset(nd_data, Group %in% c('HC', 'PS', 'NS'))
sub1data$Group <- factor(sub1data$Group, levels = c('HC', 'PS', 'NS'))
sub2data <- subset(nd_data, Group %in% c('HC', 'PS', 'BA', 'WD'))
sub2data$Group <- factor(sub2data$Group, levels = c('HC', 'PS', 'BA', 'WD'))
colors_3group <- c('HC' = '#66c2a5', 'PS' = '#fc8d62', 'NS' = '#8da0cb')
colors_4group <- c('HC' = '#66c2a5', 'PS' = '#fc8d62', 'BA' = '#e78ac3', 'WD' = '#a6d854')

create_models <- function(data) {
  IC_model <- glm(IC ~ Group * (Prior_IC + Prior_WS + IC_pcs + WS_pcs + Pr_IC + Pr_WS), 
                  data = data, family = gaussian())
  WS_model <- glm(WS ~ Group * (Prior_IC + Prior_WS + IC_pcs + WS_pcs + Pr_IC + Pr_WS),
                  data = data, family = gaussian())
  return(list(IC_model = IC_model, WS_model = WS_model))}
models1 <- create_models(sub1data)
models2 <- create_models(sub2data)

extract_contrasts <- function(model, vars, groups, contrasts) {
  results <- list()
  for (var in vars) {
    em <- emtrends(model, var = var, specs = ~ Group)
    contrast_results <- lapply(contrasts, function(c) contrast(em, method = list(c)))
    summary_results <- lapply(contrast_results, summary)
    p_values <- sapply(summary_results, function(res) res$p.value)
    p_values_adj <- p.adjust(p_values, method = "bonferroni")
    for (i in seq_along(summary_results)) {summary_results[[i]]$p.value <- p_values_adj[i]}
    results[[var]] <- summary_results}
  return(results)}

vars <- c("Prior_IC", "Prior_WS", "IC_pcs", "WS_pcs", "Pr_IC", "Pr_WS")
outcomes <- c("IC", "WS")
contrasts_3group <- list("HC vs PS" = c(-1, 1, 0),"HC vs NS" = c(-1, 0, 1),"PS vs NS" = c(0, -1, 1))
contrasts_4group <- list(
  "HC vs PS" = c(-1, 1, 0, 0),  "HC vs BA" = c(-1, 0, 1, 0),  "HC vs WD" = c(-1, 0, 0, 1),
  "PS vs BA" = c(0, -1, 1, 0),  "PS vs WD" = c(0, -1, 0, 1),  "BA vs WD" = c(0, 0, -1, 1))
results_3group_IC <- extract_contrasts(models1$IC_model, vars, sub1data$Group, contrasts_3group)
results_3group_WS <- extract_contrasts(models1$WS_model, vars, sub1data$Group, contrasts_3group)
results_4group_IC <- extract_contrasts(models2$IC_model, vars, sub2data$Group, contrasts_4group)
results_4group_WS <- extract_contrasts(models2$WS_model, vars, sub2data$Group, contrasts_4group)

print_contrast_results <- function(results) {
  for (var in names(results)) {
    cat("\nVariable:", var, "\n")
    for (contrast_name in names(results[[var]])) {
      cat("\nContrast:", contrast_name, "\n")
      print(results[[var]][[contrast_name]])}}}
print_contrast_results(results_3group_IC)
print_contrast_results(results_3group_WS)
print_contrast_results(results_4group_IC)
print_contrast_results(results_4group_WS)

create_significance_matrix <- function(results, groups, contrasts, vars) {
  significance_matrix <- matrix(0, nrow = length(groups), ncol = length(vars))
  rownames(significance_matrix) <- groups
  colnames(significance_matrix) <- vars
  for (var in vars) {
    for (contrast_name in names(contrasts)) {
      p_val <- results[[var]][[contrast_name]]$p.value  
      if (p_val < 0.05) {contrast_vec <- contrasts[[contrast_name]]  
        selected_groups <- which(contrast_vec != 0)  
        significance_matrix[selected_groups, var] <- 1 }}}
  return(significance_matrix)}

matrix_3group_IC <- create_significance_matrix(results_3group_IC, c("HC", "PS", "NS"), contrasts_3group, vars)
matrix_3group_WS <- create_significance_matrix(results_3group_WS, c("HC", "PS", "NS"), contrasts_3group, vars)
matrix_4group_IC <- create_significance_matrix(results_4group_IC, c("HC", "PS", "BA", "WD"), contrasts_4group, vars)
matrix_4group_WS <- create_significance_matrix(results_4group_WS, c("HC", "PS", "BA", "WD"), contrasts_4group, vars)

generate_scatter_plots <- function(data, group_colors, group_name, outcome_matrix, save_path) {
  for (predictor in vars) {
    outcome_var <- sub(".*_", "", group_name)  
    relative_folder <- "simulation/plots"
    dir.create(relative_folder, showWarnings = FALSE)
    file_name <- file.path(relative_folder, paste0("scatter_", group_name, "_", predictor, ".png"))

    p <- ggplot(data, aes_string(x = predictor, y = outcome_var, color = "Group")) +
      geom_point(size = 2, alpha = 0.5, shape = 1) + 
      geom_smooth(data = subset(data, Group %in% rownames(outcome_matrix)[outcome_matrix[, predictor] == 1]),
                  method = "lm", se = FALSE, aes_string(color = "Group")) + 
      scale_color_manual(values = group_colors) +
      theme_minimal(base_family = "sans") +
      coord_cartesian(ylim = c(0, 1),xlim = if (predictor %in% c("Pr_IC", "Pr_WS")) c(0, 1.50) else c(0, 1)) +
      theme(panel.background = element_rect(fill = "white", color = NA),
        plot.background = element_rect(fill = "white", color = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "black"),
        legend.position = "none") +
      labs(x = predictor, y = outcome_var)

    p <- ggMarginal(p, type = "density", margins = "both", groupColour = TRUE, groupFill = TRUE)
    ggsave(file_name, plot = p, width = 5, height = 5, dpi = 300)
    cat(sprintf("Group: %s | Predictor: %s | Slope:\n", group_name, predictor))
    for (group in unique(data$Group)) {
      subset_data <- subset(data, Group == group)
      model <- lm(as.formula(paste(outcome_var, "~", predictor)), data = subset_data)
      model_beta <- lm.beta(model)  
      slope <- coef(model_beta)[2]  # standardized beta
      slopep <- summary(model)$coefficients[2, 4]  # p value
      cat(sprintf("  %s: slope=%.4f, p=%.4f\n", group, slope, slopep))}
    cat(sprintf("![](%s)\n\n", file_name))}}

generate_scatter_plots(sub1data, colors_3group, "3group_IC", matrix_3group_IC, paste0(file_path, 'scatterplots'))
generate_scatter_plots(sub1data, colors_3group, "3group_WS", matrix_3group_WS, paste0(file_path, 'scatterplots'))
generate_scatter_plots(sub2data, colors_4group, "4group_IC", matrix_4group_IC, paste0(file_path, 'scatterplots'))
generate_scatter_plots(sub2data, colors_4group, "4group_WS", matrix_4group_WS, paste0(file_path, 'scatterplots'))
```